#!/bin/bash
# t - Attach or switch to named tmux session
# Usage: t [session-name|clean|a|attach]

# Helper: clean unattached numbered tmux sessions, returns count
_tmux_clean_numbered() {
  local deleted=0
  for name in $(tmux list-sessions -F '#{session_name}' 2>/dev/null); do
    [[ ! "$name" =~ ^[0-9]+$ ]] && continue
    [[ "$(tmux display-message -t "$name" -p '#{session_attached}')" == "1" ]] && continue
    tmux kill-session -t "$name" 2>/dev/null && ((deleted++))
  done
  echo $deleted
}

session="${1:-}"

if [[ -z "$session" ]]; then
  # No args: clean and list
  _tmux_clean_numbered >/dev/null
  tmux ls
elif [[ "$session" == "clean" ]]; then
  # Clean numbered sessions
  echo "Deleted $(_tmux_clean_numbered) session(s)"
elif [[ "$session" == "a" || "$session" == "attach" ]]; then
  # Reattach to most recent session
  tmux attach
else
  # Attach or create named session
  if [[ -n "$TMUX" ]]; then
    if ! tmux has-session -t "$session" 2>/dev/null; then
      tmux new-session -ds "$session" -n main
    fi
    tmux switch-client -t "$session"
    _tmux_clean_numbered >/dev/null
  else
    tmux new-session -As "$session" -n main
  fi
fi
